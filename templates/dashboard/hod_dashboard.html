{% extends 'base.html' %}
{% block title %}HOD Dashboard{% endblock %}
{% block content %}

<div class="container-fluid ">
  <div class="d-flex justify-content-between align-items-center mb-4">
    <h2 class="fw-bold">HOD Dashboard</h2>
    <a href="{% url 'request_history' %}" class="btn btn-primary">
      <i class="fas fa-history me-2"></i>Full Request History
    </a>
  </div>

  <!-- Stats Cards -->
  <div class="row g-4 mb-5">
    <div class="col-md-3">
      <div class="card shadow-sm border-0 h-100">
        <div class="card-body bg-secondary bg-opacity-10 rounded">
          <div class="d-flex justify-content-between">
            <div>
              <h6 class="text-muted mb-1">Total Requests</h6>
              <h3 class="fw-bold mb-0">{{ total_requests }}</h3>
            </div>
            <div class="rounded-circle bg-secondary d-flex align-items-center justify-content-center" style="width: 48px; height: 48px;">
              <i class="fas fa-clipboard-list text-white"></i>
            </div>
          </div>
        </div>
      </div>
    </div>
    
    <div class="col-md-3">
      <div class="card shadow-sm border-0 h-100">
        <div class="card-body bg-warning bg-opacity-10 rounded">
          <div class="d-flex justify-content-between">
            <div>
              <h6 class="text-muted mb-1">Pending</h6>
              <h3 class="fw-bold mb-0">{{ pending_requests }}</h3>
            </div>
            <div class="rounded-circle bg-warning d-flex align-items-center justify-content-center" style="width: 48px; height: 48px;">
              <i class="fas fa-clock text-white"></i>
            </div>
          </div>
        </div>
      </div>
    </div>
    
    <div class="col-md-3">
      <div class="card shadow-sm border-0 h-100">
        <div class="card-body bg-success bg-opacity-10 rounded">
          <div class="d-flex justify-content-between">
            <div>
              <h6 class="text-muted mb-1">Approved</h6>
              <h3 class="fw-bold mb-0">{{ approved_requests }}</h3>
            </div>
            <div class="rounded-circle bg-success d-flex align-items-center justify-content-center" style="width: 48px; height: 48px;">
              <i class="fas fa-check text-white"></i>
            </div>
          </div>
        </div>
      </div>
    </div>
    
    <div class="col-md-3">
      <div class="card shadow-sm border-0 h-100">
        <div class="card-body bg-danger bg-opacity-10 rounded">
          <div class="d-flex justify-content-between">
            <div>
              <h6 class="text-muted mb-1">Rejected</h6>
              <h3 class="fw-bold mb-0">{{ rejected_requests }}</h3>
            </div>
            <div class="rounded-circle bg-danger d-flex align-items-center justify-content-center" style="width: 48px; height: 48px;">
              <i class="fas fa-times text-white"></i>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- Chart and Tabs Section -->
  <div class="row g-4">
    <!-- Chart Section -->
    <div class="col-md-4">
      <div class="card shadow-sm border-0 h-100">
        <div class="card-header bg-white border-0">
          <h5 class="card-title mb-0">Request Status Overview</h5>
        </div>
        <div class="card-body d-flex align-items-center justify-content-center">
          <div style="max-width: 100%; height: 300px;">
            <canvas id="statusChart"></canvas>
          </div>
        </div>
      </div>
    </div>
    
    <!-- Tabs Section -->
    <div class="col-md-8">
      <div class="card shadow-sm border-0">
        <div class="card-header bg-white p-0 border-0">
          <ul class="nav nav-tabs" id="requestTabs">
            <li class="nav-item">
              <a class="nav-link active py-3 px-4" data-bs-toggle="tab" href="#all">
                <i class="fas fa-list-ul me-2"></i>All Requests
              </a>
            </li>
            <li class="nav-item">
              <a class="nav-link py-3 px-4" data-bs-toggle="tab" href="#pending">
                <i class="fas fa-hourglass-half me-2"></i>Pending
              </a>
            </li>
            <li class="nav-item">
              <a class="nav-link py-3 px-4" data-bs-toggle="tab" href="#approved">
                <i class="fas fa-check-circle me-2"></i>Approved
              </a>
            </li>
          </ul>
        </div>
        
        <div class="card-body">
          <div class="tab-content">
            <!-- All Requests Tab -->
            <div class="tab-pane fade show active" id="all">
              <div class="table-responsive">
                <table class="table table-hover align-middle">
                  <thead class="table-light">
                    <tr>
                      <th>Item</th>
                      <th>Requested By</th>
                      <th>Quantity</th>
                      <th>Available</th>
                      <th>Date</th>
                      <th>Status</th>
                    </tr>
                  </thead>
                  <tbody>
                    {% for req in recent_requests %}
                      <tr>
                        <td class="fw-medium">{{ req.item.name }}</td>
                        <td>{{ req.user.username }}</td>
                        <td>{{ req.quantity }}</td>
                        <td>{{ req.item.quantity }}</td>
                        <td>{{ req.request_date|date:"Y-m-d H:i" }}</td>
                        <td>
                          {% if req.status == "pending" %}
                            <span class="badge bg-warning text-dark">Pending</span>
                          {% elif req.status == "approved" %}
                            <span class="badge bg-success">Approved</span>
                          {% else %}
                            <span class="badge bg-danger">Rejected</span>
                          {% endif %}
                        </td>
                      </tr>
                    {% endfor %}
                  </tbody>
                </table>
              </div>
            </div>
            
            <!-- Pending Requests Tab -->
            <div class="tab-pane fade" id="pending">
              <div class="table-responsive">
                <table class="table table-hover align-middle">
                  <thead class="table-light">
                    <tr>
                      <th>Item</th>
                      <th>Requested By</th>
                      <th>Quantity</th>
                      <th>Available</th>
                      <th>Date</th>
                      <th>Action</th>
                    </tr>
                  </thead>
                  <tbody>
                    {% for req in recent_requests %}
                      {% if req.status == "pending" %}
                        <tr>
                          <td class="fw-medium">{{ req.item.name }}</td>
                          <td>{{ req.user.username }}</td>
                          <td>{{ req.quantity }}</td>
                          <td>{{ req.item.quantity }}</td>
                          <td>{{ req.request_date|date:"Y-m-d H:i" }}</td>
                          <td>
                            <form method="post" action="{% url 'process_request' req.id %}" class="d-flex gap-2">
                              {% csrf_token %}
                              <button name="action" value="approve" class="btn btn-sm btn-success">
                                <i class="fas fa-check me-1"></i> Approve
                              </button>
                              <button name="action" value="reject" class="btn btn-sm btn-danger">
                                <i class="fas fa-times me-1"></i> Reject
                              </button>
                            </form>
                          </td>
                        </tr>
                      {% endif %}
                    {% endfor %}
                  </tbody>
                </table>
              </div>
            </div>
            
            <!-- Approved Requests Tab -->
            <div class="tab-pane fade" id="approved">
              <div class="table-responsive">
                <table class="table table-hover align-middle">
                  <thead class="table-light">
                    <tr>
                      <th>Item</th>
                      <th>Requested By</th>
                      <th>Quantity</th>
                      <th>Available</th>
                      <th>Date</th>
                    </tr>
                  </thead>
                  <tbody>
                    {% for req in recent_requests %}
                      {% if req.status == "approved" %}
                        <tr>
                          <td class="fw-medium">{{ req.item.name }}</td>
                          <td>{{ req.user.username }}</td>
                          <td>{{ req.quantity }}</td>
                          <td>{{ req.item.quantity }}</td>
                          <td>{{ req.request_date|date:"Y-m-d H:i" }}</td>
                        </tr>
                      {% endif %}
                    {% endfor %}
                  </tbody>
                </table>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>
</div>


<!-- Chart.js Script -->
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script>
  document.addEventListener('DOMContentLoaded', function() {
    const ctx = document.getElementById('statusChart').getContext('2d');
    new Chart(ctx, {
      type: 'doughnut',
      data: {
        labels: ['Pending', 'Approved', 'Rejected'],
        datasets: [{
          data: [{% if pending_requests %}{{ pending_requests }}{% else %}0{% endif %}, 
                 {% if approved_requests %}{{ approved_requests }}{% else %}0{% endif %}, 
                 {% if rejected_requests %}{{ rejected_requests }}{% else %}0{% endif %}],
          backgroundColor: ['#ffc107', '#198754', '#dc3545'],
          borderWidth: 0
        }]
      },
      options: {
        responsive: true,
        maintainAspectRatio: false,
        cutout: '70%',
        plugins: {
          legend: {
            position: 'bottom',
            labels: {
              padding: 20,
              usePointStyle: true,
              pointStyle: 'circle'
            }
          }
        }
      }
    });
  });
</script>

{% endblock %}